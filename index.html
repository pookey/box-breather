<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Box Breathing</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-base: 4%;
      --text-primary: rgba(255, 255, 255, 0.6);
      --text-muted: rgba(255, 255, 255, 0.35);
      --border-subtle: rgba(255, 255, 255, 0.12);
      --border-hover: rgba(255, 255, 255, 0.25);
      --glow-color: rgba(255, 255, 255, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: hsl(220, 8%, var(--bg-base));
      font-family: 'Cormorant Garamond', Georgia, serif;
      overflow: hidden;
    }

    .container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .box-container {
      position: relative;
      width: 240px;
      height: 240px;
      cursor: pointer;
    }

    .box {
      width: 100%;
      height: 100%;
      border: 1px solid var(--border-subtle);
      transition: border-color 0.4s ease;
    }

    .box-container:hover .box {
      border-color: var(--border-hover);
    }

    .chaser {
      position: absolute;
      width: 10px;
      height: 10px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow:
        0 0 20px var(--glow-color),
        0 0 40px rgba(255, 255, 255, 0.15);
      transition: box-shadow 0.3s ease;
    }

    .box-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .phase-label {
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 300;
      letter-spacing: 0.25em;
      text-transform: lowercase;
      transition: opacity 0.4s ease, color 0.4s ease;
    }

    .timer-display {
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 300;
      letter-spacing: 0.15em;
      opacity: 0;
      transition: opacity 0.4s ease;
      font-variant-numeric: tabular-nums;
    }

    .timer-display.visible {
      opacity: 1;
    }

    .box-container:hover .phase-label,
    .box-container:hover .timer-display {
      color: var(--text-primary);
    }

    /* Settings Toggle */
    .settings-toggle {
      position: fixed;
      bottom: 28px;
      right: 28px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.25;
      transition: opacity 0.3s ease, transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .settings-toggle:hover {
      opacity: 0.6;
    }

    .settings-toggle.active {
      opacity: 0.5;
      transform: rotate(90deg);
    }

    .settings-toggle svg {
      width: 20px;
      height: 20px;
      stroke: white;
      stroke-width: 1.5;
      fill: none;
    }

    /* Settings Panel */
    .settings {
      position: fixed;
      bottom: 28px;
      right: 76px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 16px;
      opacity: 0;
      visibility: hidden;
      transform: translateX(10px);
      transition:
        opacity 0.3s ease,
        visibility 0.3s ease,
        transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .settings.visible {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
    }

    .setting-row {
      display: flex;
      align-items: center;
      gap: 14px;
      color: var(--text-muted);
      font-size: 11px;
      letter-spacing: 0.15em;
      text-transform: lowercase;
    }

    .setting-row label {
      min-width: 90px;
      text-align: right;
      transition: color 0.2s ease;
    }

    .setting-row:hover label {
      color: var(--text-primary);
    }

    input[type="range"] {
      width: 100px;
      height: 1px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--border-subtle);
      outline: none;
      transition: background 0.2s ease;
    }

    .setting-row:hover input[type="range"] {
      background: var(--border-hover);
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 10px;
      height: 10px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      background: rgba(255, 255, 255, 0.8);
      transform: scale(1.2);
    }

    input[type="range"]::-moz-range-thumb {
      width: 10px;
      height: 10px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    input[type="range"]::-moz-range-thumb:hover {
      background: rgba(255, 255, 255, 0.8);
      transform: scale(1.2);
    }

    .duration-value {
      min-width: 24px;
      text-align: left;
      font-variant-numeric: tabular-nums;
    }

    .session-presets {
      display: flex;
      gap: 8px;
    }

    .session-preset {
      padding: 4px 10px;
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
      font-family: inherit;
      font-size: 10px;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .session-preset:hover {
      border-color: var(--border-hover);
      color: var(--text-primary);
    }

    .session-preset.active {
      border-color: var(--text-primary);
      color: var(--text-primary);
    }

    /* Info Toggle */
    .info-toggle {
      position: fixed;
      bottom: 28px;
      left: 28px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.25;
      transition: opacity 0.3s ease;
    }

    .info-toggle:hover {
      opacity: 0.6;
    }

    .info-toggle.active {
      opacity: 0.5;
    }

    .info-toggle svg {
      width: 18px;
      height: 18px;
      stroke: white;
      stroke-width: 1.5;
      fill: none;
    }

    /* Info Panel */
    .info-panel {
      position: fixed;
      bottom: 28px;
      left: 70px;
      max-width: 280px;
      opacity: 0;
      visibility: hidden;
      transform: translateX(-10px);
      transition:
        opacity 0.3s ease,
        visibility 0.3s ease,
        transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .info-panel.visible {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
    }

    .info-panel p {
      color: var(--text-muted);
      font-size: 12px;
      line-height: 1.7;
      letter-spacing: 0.02em;
    }

    .info-panel p + p {
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="box-container">
      <div class="box"></div>
      <div class="chaser"></div>
      <div class="box-content">
        <div class="phase-label">begin</div>
        <div class="timer-display" id="timer-display"></div>
      </div>
    </div>
  </div>

  <div class="info-toggle" id="info-toggle">
    <svg viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="16" x2="12" y2="12"/>
      <line x1="12" y1="8" x2="12.01" y2="8"/>
    </svg>
  </div>

  <div class="info-panel" id="info-panel">
    <p>Box breathing is a simple technique used by everyone from Navy SEALs to athletes to calm the nervous system and sharpen focus.</p>
    <p>Equal intervals of inhaling, holding, exhaling, and holding again activate the parasympathetic response, lowering stress hormones and bringing clarity to a scattered mind.</p>
  </div>

  <div class="settings-toggle" id="settings-toggle">
    <svg viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="3"/>
      <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
    </svg>
  </div>

  <div class="settings" id="settings">
    <div class="setting-row">
      <label>session</label>
      <div class="session-presets">
        <button class="session-preset active" data-minutes="2">2m</button>
        <button class="session-preset" data-minutes="5">5m</button>
        <button class="session-preset" data-minutes="10">10m</button>
        <button class="session-preset" data-minutes="0">âˆž</button>
      </div>
    </div>
    <div class="setting-row">
      <label>pace</label>
      <input type="range" id="duration" min="3" max="6" step="0.5" value="4">
      <span class="duration-value" id="duration-value">4s</span>
    </div>
    <div class="setting-row">
      <label>brightness</label>
      <input type="range" id="brightness" min="0" max="100" step="5" value="30">
    </div>
    <div class="setting-row">
      <label>sound</label>
      <input type="range" id="volume" min="0" max="100" step="5" value="50">
    </div>
  </div>

  <script>
    const chaser = document.querySelector('.chaser');
    const phaseLabel = document.querySelector('.phase-label');
    const timerDisplay = document.getElementById('timer-display');
    const durationSlider = document.getElementById('duration');
    const durationValue = document.getElementById('duration-value');
    const brightnessSlider = document.getElementById('brightness');
    const volumeSlider = document.getElementById('volume');
    const boxContainer = document.querySelector('.box-container');
    const settingsToggle = document.getElementById('settings-toggle');
    const settings = document.getElementById('settings');
    const infoToggle = document.getElementById('info-toggle');
    const infoPanel = document.getElementById('info-panel');
    const sessionPresets = document.querySelectorAll('.session-preset');

    let duration = 4;
    let brightnessIntensity = 30;
    let volume = 0.5;
    let sessionMinutes = 2; // 0 = endless
    let isRunning = false;
    let animationId = null;
    let lastPhaseIndex = -1;
    let audioContext = null;
    let settingsVisible = true;
    let infoVisible = false;
    let startTime = null;

    // Load settings from localStorage
    function loadSettings() {
      const saved = localStorage.getItem('boxBreatherSettings');
      if (saved) {
        const s = JSON.parse(saved);
        duration = s.duration ?? 4;
        brightnessIntensity = s.brightness ?? 30;
        volume = s.volume ?? 0.5;
        sessionMinutes = s.sessionMinutes ?? 2;

        durationSlider.value = duration;
        durationValue.textContent = `${duration}s`;
        brightnessSlider.value = brightnessIntensity;
        volumeSlider.value = volume * 100;

        sessionPresets.forEach(btn => {
          btn.classList.toggle('active', parseInt(btn.dataset.minutes) === sessionMinutes);
        });
      }
    }

    function saveSettings() {
      localStorage.setItem('boxBreatherSettings', JSON.stringify({
        duration,
        brightness: brightnessIntensity,
        volume,
        sessionMinutes
      }));
    }

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playClick() {
      if (!audioContext || volume === 0) return;

      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = 600;
      oscillator.type = 'sine';

      const now = audioContext.currentTime;
      gainNode.gain.setValueAtTime(volume * 0.2, now);
      gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.06);

      oscillator.start(now);
      oscillator.stop(now + 0.06);
    }

    const phases = [
      { name: 'inhale', startX: 0, startY: 0, endX: 0, endY: 100 },
      { name: 'hold', startX: 0, startY: 100, endX: 100, endY: 100 },
      { name: 'exhale', startX: 100, startY: 100, endX: 100, endY: 0 },
      { name: 'hold', startX: 100, startY: 0, endX: 0, endY: 0 }
    ];

    function setPosition(xPercent, yPercent) {
      chaser.style.left = `${xPercent}%`;
      chaser.style.top = `${yPercent}%`;
    }

    function updateBackground(phaseIndex, progress) {
      const maxBrightness = brightnessIntensity;
      const minBrightness = 4;

      let brightness;
      if (phaseIndex === 0) {
        brightness = minBrightness + (progress * (maxBrightness - minBrightness));
      } else if (phaseIndex === 1) {
        brightness = maxBrightness;
      } else if (phaseIndex === 2) {
        brightness = maxBrightness - (progress * (maxBrightness - minBrightness));
      } else {
        brightness = minBrightness;
      }

      document.body.style.backgroundColor = `hsl(220, 8%, ${brightness}%)`;
    }

    function easeInOutSine(t) {
      return -(Math.cos(Math.PI * t) - 1) / 2;
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function animate() {
      if (!isRunning) return;

      const now = performance.now();
      const elapsed = now - startTime;
      const totalCycleDuration = duration * 4 * 1000;
      const cycleProgress = (elapsed % totalCycleDuration) / totalCycleDuration;
      const phaseIndex = Math.floor(cycleProgress * 4);
      const phaseProgress = (cycleProgress * 4) % 1;

      // Check if session has ended
      if (sessionMinutes > 0) {
        const sessionMs = sessionMinutes * 60 * 1000;
        const remaining = Math.max(0, sessionMs - elapsed);

        timerDisplay.textContent = formatTime(remaining / 1000);

        if (remaining <= 0) {
          endSession();
          return;
        }
      }

      const phase = phases[phaseIndex];
      const easedProgress = easeInOutSine(phaseProgress);

      const x = phase.startX + (phase.endX - phase.startX) * easedProgress;
      const y = phase.startY + (phase.endY - phase.startY) * easedProgress;

      setPosition(x, y);
      phaseLabel.textContent = phase.name;
      updateBackground(phaseIndex, phaseProgress);

      if (phaseIndex !== lastPhaseIndex) {
        playClick();
        lastPhaseIndex = phaseIndex;
      }

      animationId = requestAnimationFrame(animate);
    }

    function endSession() {
      isRunning = false;
      cancelAnimationFrame(animationId);
      phaseLabel.textContent = 'complete';
      timerDisplay.classList.remove('visible');
      document.body.style.backgroundColor = 'hsl(220, 8%, 4%)';
      setPosition(0, 0);
      lastPhaseIndex = -1;
      startTime = null;

      // Reset to "begin" after a moment
      setTimeout(() => {
        if (!isRunning) {
          phaseLabel.textContent = 'begin';
        }
      }, 2000);
    }

    function start() {
      if (isRunning) {
        isRunning = false;
        cancelAnimationFrame(animationId);
        phaseLabel.textContent = 'begin';
        timerDisplay.classList.remove('visible');
        document.body.style.backgroundColor = 'hsl(220, 8%, 4%)';
        setPosition(0, 0);
        lastPhaseIndex = -1;
        startTime = null;
        return;
      }

      initAudio();
      startTime = performance.now();
      lastPhaseIndex = -1;
      isRunning = true;

      // Hide settings when starting
      if (settingsVisible) {
        settingsVisible = false;
        settings.classList.remove('visible');
        settingsToggle.classList.remove('active');
      }

      // Show timer if session has a duration
      if (sessionMinutes > 0) {
        timerDisplay.textContent = formatTime(sessionMinutes * 60);
        timerDisplay.classList.add('visible');
      }

      playClick(); // Play click for initial inhale
      animate();
    }

    function toggleSettings() {
      settingsVisible = !settingsVisible;
      settings.classList.toggle('visible', settingsVisible);
      settingsToggle.classList.toggle('active', settingsVisible);
    }

    function toggleInfo() {
      infoVisible = !infoVisible;
      infoPanel.classList.toggle('visible', infoVisible);
      infoToggle.classList.toggle('active', infoVisible);
    }

    durationSlider.addEventListener('input', (e) => {
      duration = parseFloat(e.target.value);
      durationValue.textContent = `${duration}s`;
      saveSettings();
    });

    brightnessSlider.addEventListener('input', (e) => {
      brightnessIntensity = parseFloat(e.target.value);
      saveSettings();
    });

    volumeSlider.addEventListener('input', (e) => {
      volume = parseFloat(e.target.value) / 100;
      saveSettings();
    });

    boxContainer.addEventListener('click', start);
    settingsToggle.addEventListener('click', toggleSettings);
    infoToggle.addEventListener('click', toggleInfo);

    sessionPresets.forEach(btn => {
      btn.addEventListener('click', () => {
        sessionMinutes = parseInt(btn.dataset.minutes);
        sessionPresets.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        saveSettings();
      });
    });

    loadSettings();
    setPosition(0, 0);

    // Show settings on page load
    settings.classList.add('visible');
    settingsToggle.classList.add('active');
  </script>
</body>
</html>
